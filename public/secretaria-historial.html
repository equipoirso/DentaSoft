<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Secretar√≠a ¬∑ Historia Cl√≠nica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="./styles.css"/>

  <!-- Firebase + app -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script defer src="./common.js"></script>
  <script defer src="./secretaria-historial.js"></script>
</head>
<body>
<header class="topbar">
  <div class="logo">ü¶∑ <span>DENTASOFT</span></div>
  <nav class="menu">
    <a class="backlink upper" href="./secretaria.html">ATR√ÅS</a>
  </nav>
</header>

<section class="container">
  <div class="page-head"><h1 class="headline-xl">Historia Cl√≠nica</h1></div>

  <!-- === CUADRO 1: Buscar + Datos paciente + Agregar visita (todo junto) === -->
  <div class="card" id="cardPrincipal">
    <!-- 1) Ingresar DNI -->
    <h3 class="subtitle">Ingresar DNI del paciente</h3>
    <div class="inline">
      <input id="hDni" class="grow" inputmode="numeric" maxlength="8" placeholder="Ingres√° el DNI del paciente">
      <button id="hBuscar" class="btn btn-primary">Buscar</button>
    </div>

    <!-- 2) Datos del paciente -->
    <div id="pacientePreview" class="subcard hidden mt-12">
      <div class="headline-s mb-6">Paciente</div>
      <div class="grid-2">
        <div><strong>Nombre:</strong> <span id="pNombre"></span></div>
        <div><strong>Apellido:</strong> <span id="pApellido"></span></div>
        <div><strong>Email:</strong> <span id="pEmail"></span></div>
        <div><strong>Tel√©fono:</strong> <span id="pTelefono"></span></div>
        <div class="span-2"><strong>Obra Social:</strong> <span id="pObra"></span></div>
      </div>
    </div>

    <div class="divider"></div> <!-- separador √∫nico -->

    <!-- 3) Agregar nueva visita -->
    <!-- <h3 class="subtitle center">Agregar nueva visita</h3>  Se coment√≥ est√° linea 12/10 - Dani -->
    <br id="formHist">
      <div class="grid-2">
        <!-- Fecha -->
        <label>Fecha de la visita
          <input type="date" id="fechaDiaUI" name="fechaDiaUI" required>
        </label>

        <!-- Hora (09:00 a 17:30 cada 30') -->
        <label>Hora de la visita
          <select id="horaVisita" name="horaVisita" required>
            <option value="">Seleccionar‚Ä¶</option>
            <option value="09:00">09:00</option>
            <option value="09:30">09:30</option>
            <option value="10:00">10:00</option>
            <option value="10:30">10:30</option>
            <option value="11:00">11:00</option>
            <option value="11:30">11:30</option>
            <option value="12:00">12:00</option>
            <option value="12:30">12:30</option>
            <option value="13:00">13:00</option>
            <option value="13:30">13:30</option>
            <option value="14:00">14:00</option>
            <option value="14:30">14:30</option>
            <option value="15:00">15:00</option>
            <option value="15:30">15:30</option>
            <option value="16:00">16:00</option>
            <option value="16:30">16:30</option>
            <option value="17:00">17:00</option>
            <option value="17:30">17:30</option>
          </select>
        </label>

        <!-- Campo oculto que usa tu JS actual (NO tocar secretaria-historial.js) -->
        <input type="hidden" id="fechaVisita" name="fechaVisita">

        <!-- Odont√≥logo -->
        <label>Odont√≥logo
          <select id="selOdo" name="odontologoUid" required>
            <option value="">Cargando‚Ä¶</option>
          </select>
        </label>

        <!-- Motivo -->
        <label>Motivo
          <select name="motivo" required>
            <option value="" disabled selected>Seleccionar‚Ä¶</option>
            <option>Limpieza</option>
            <option>Extracci√≥n</option>
            <option>Obturaci√≥n (caries)</option>
            <option>Endodoncia</option>
            <option>Control</option>
          </select>
        </label>

        <!-- Estado administrativo -->
        <label>Estado
          <select name="estadoTurno" required>
            <option>programado</option>
            <option>completado</option>
            <option>cancelado</option>
            <option>pospuesto</option>
          </select>
        </label>

        <!-- Pagado -->
        <label>Pagado
          <select name="pagado">
            <option value="true">S√≠</option>
            <option value="false">No</option>
          </select>
        </label>

        <!-- Notas -->
        <label class="span-2">Notas de la visita
          <textarea name="descripcion" id="notas" rows="3" maxlength="500" placeholder="Observaciones administrativas (no cl√≠nicas)‚Ä¶"></textarea>
        </label>
      </div>
      <p></p>
      <!-- Acciones -->
      <div class="actions centered">
        <button type="submit" class="btn btn-primary">Guardar Visita</button>
        <button type="button" id="btnCancelar" class="btn">Cancelar</button>
      </div>
    </form>

    <!-- Mensajes -->
    <div id="status" class="notice hidden mt-10"></div>
  </div>

  <!-- === CUADRO 2: Visitas registradas === -->
  <div class="card">
    <div class="header-with-action">
      <h3 class="subtitle center">Visitas registradas</h3>
      <button id="btnToggleVisitas" class="btn action-right" disabled>Ver visitas</button>
    </div>

    <div id="visitasWrap" class="subcard hidden mt-8">
      <ul id="hLista" class="list-reset pl-18"></ul>

      <!-- Botones del historial -->
      <div class="actions centered mt-12">
        <button id="btnPrintVisitas" class="btn" disabled>Imprimir</button>
        <button id="btnCerrarVisitas" class="btn">Cancelar</button>
      </div>
    </div>
    <p></p>
    <div class="muted mt-6" id="visitasHint">Busc√° un paciente para habilitar este panel.</div>
  </div>
</section>

<!-- Sin cambiar tu JS existente:
     antes de enviar el formulario, combinamos fecha + hora en "fechaVisita" -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('formHist');
    const fechaDiaUI = document.getElementById('fechaDiaUI');
    const horaVisita = document.getElementById('horaVisita');
    const fechaVisitaHidden = document.getElementById('fechaVisita');

    form.addEventListener('submit', () => {
      if (fechaDiaUI.value && horaVisita.value) {
        // Genera "YYYY-MM-DDTHH:MM" que tu JS ya transforma a Date()
        fechaVisitaHidden.value = `${fechaDiaUI.value}T${horaVisita.value}`;
      } else {
        fechaVisitaHidden.value = ''; // Deja que tu JS use "ahora" como fallback
      }
    });
  });
</script>
</body>
</html>
